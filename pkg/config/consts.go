package config

import (
	"bytes"
	"encoding/hex"
	"log"

	"github.com/dusk-network/dusk-blockchain/pkg/core/data/block"
	"github.com/dusk-network/dusk-blockchain/pkg/core/data/wallet"
	"github.com/dusk-network/dusk-blockchain/pkg/p2p/wire/message"
	"github.com/dusk-network/dusk-blockchain/pkg/util/legacy"
)

// A single point of constants definition
const (
	// GeneratorReward is the amount of Block generator default reward
	// TODO: TBD
	GeneratorReward = 50 * wallet.DUSK

	MinFee = uint64(100)

	// MaxLockTime is the maximum amount of time a consensus transaction (stake, bid)
	// can be locked up for
	MaxLockTime = uint64(250000)

	// GenesisBlockBlob represents the genesis block bytes in hexadecimal format
	// It's recommended to be regenerated with generation.GenerateGensisBlock() API
	TestNetGenesisBlob = "00000000000000000011d8675f000000000000000000000000000000000000000000000000000000000000000000000000fea85f497e1444a796d5d12988714d5f709cec443b78b8f6a871660fcefb614f65036e0f0865e092bc5b5434a40e11894afb5b88df7fb2efa4318998905e3bea4b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d389710287e3b2f0df6e1777ecce638bdeeaa268b4f7bb3ffd89269066464307010000000001000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050c30000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002abbc28747cc0cea89eba566849cec345beea49acf4d07671d41e3a06179c3e4227609a00f2052a01000000"
)

// DecodeGenesis marshals a genesis block into a buffer
func DecodeGenesis() *block.Block {
	if Get().Genesis.Legacy {
		g := legacy.DecodeGenesis()
		c, err := legacy.OldBlockToNewBlock(g)
		if err != nil {
			log.Panic(err)
		}

		return c
	}

	b := block.NewBlock()
	switch Get().General.Network {
	case "testnet": //nolint
		blob, err := hex.DecodeString(TestNetGenesisBlob)
		if err != nil {
			log.Panic(err)
		}

		var buf bytes.Buffer
		_, _ = buf.Write(blob)
		if uerr := message.UnmarshalBlock(&buf, b); uerr != nil {
			log.Panic(uerr)
		}

		sanityCheck(TestNetGenesisBlob, b)
	}
	return b
}

// nolint
func sanityCheck(genesis string, b *block.Block) {
	// sanity check the genesis block
	r := new(bytes.Buffer)
	if err := message.MarshalBlock(r, b); err != nil {
		log.Panic(err)
	}
	hgen := hex.EncodeToString(r.Bytes())
	if hgen != TestNetGenesisBlob {
		log.Panic("genesis blob is wrongly serialized")
	}
}
